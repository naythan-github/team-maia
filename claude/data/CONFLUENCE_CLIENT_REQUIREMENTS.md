# Confluence Client Requirements Specification
## TDD Phase 0 - Requirements Discovery

**Generated by**: SRE Principal Engineer Agent + Domain Specialist pairing
**Date**: 2024-11-27
**Status**: Requirements Documentation

---

## Functional Requirements

### FR-1: Primary Use Case - Create Page from Markdown

**Requirement**: One-function-call to create Confluence page from markdown content

**Acceptance Criteria**:
- ✅ Single function accepts: space_key, title, markdown_content
- ✅ Converts markdown to Confluence HTML automatically
- ✅ Returns page URL (string) on success
- ✅ Raises clear exception on failure
- ✅ Supports tables, fenced code blocks, lists, headers
- ✅ Completes within 10 seconds (P95 latency)

**Example**:
```python
client = ConfluenceClient()
url = client.create_page_from_markdown(
    space_key="Orro",
    title="IaC Strategy",
    markdown_content=markdown_string
)
# Returns: "https://vivoemc.atlassian.net/wiki/spaces/Orro/pages/123456"
```

**Priority**: P0 (Critical - 95% of use cases)

---

### FR-2: Update Existing Page

**Requirement**: Update existing page by title with automatic lookup

**Behavior Options Analyzed**:
- **Option A**: Fail if page exists (force explicit update)
- **Option B**: Auto-update if exists, create if not ✅ **SELECTED**
- **Option C**: Create versioned title (e.g., "Title (2)")

**Selected**: Option B - Auto-update with fallback to create
**Rationale**: Simplest UX, handles both cases, matches user expectations

**Acceptance Criteria**:
- ✅ Searches for existing page by title
- ✅ If found: updates content, increments version number
- ✅ If not found: creates new page
- ✅ Returns page URL in both cases
- ✅ Completes within 12 seconds (includes search + update)

**Priority**: P0 (Critical - common workflow)

---

### FR-3: Markdown Feature Support

**Required Extensions**:
- ✅ **Tables**: `| Header 1 | Header 2 |` syntax
- ✅ **Fenced Code Blocks**: ` ```python ` with language hints
- ✅ **Task Lists**: `- [ ] Task` and `- [x] Done`
- ✅ **Newline Breaks**: `nl2br` (markdown line breaks → HTML `<br>`)

**Standard Features**:
- Headers (H1-H6)
- Bold, italic, strikethrough
- Ordered and unordered lists
- Links and images
- Blockquotes
- Horizontal rules

**Not Supported** (future consideration):
- Confluence-specific macros (info panels, expand sections)
- Advanced formatting (colored text, highlights)
- Custom HTML passthrough

**Priority**: P0 (Tables and code blocks essential)

---

### FR-4: Page URL Lookup

**Requirement**: Simple lookup to get page URL by title

**Acceptance Criteria**:
- ✅ Accepts space_key and title
- ✅ Returns URL (string) if found
- ✅ Returns None if not found (not an exception)
- ✅ Completes within 3 seconds

**Priority**: P1 (Nice to have)

---

### FR-5: List Accessible Spaces

**Requirement**: Retrieve list of Confluence spaces user can access

**Acceptance Criteria**:
- ✅ Returns list of dicts: `[{key: "Orro", name: "Orro Group"}, ...]`
- ✅ Completes within 5 seconds
- ✅ Handles empty result gracefully

**Priority**: P1 (Useful for discovery)

---

### FR-6: Delete Page

**Requirement**: Delete page by title

**Status**: ⚠️ **DEFERRED** - `ReliableConfluenceClient` doesn't have delete method
**Decision**: Raise `NotImplementedError` with clear message
**Future**: Add to underlying client when needed

**Priority**: P2 (Low priority - rarely used)

---

## Non-Functional Requirements

### NFR-1: Performance - Latency SLO

**Requirement**: Operations complete within acceptable time

**SLO Targets**:
| Operation | P50 Latency | P95 Latency | P99 Latency |
|-----------|-------------|-------------|-------------|
| Create page | <3 seconds | <5 seconds | <10 seconds |
| Update page | <4 seconds | <7 seconds | <12 seconds |
| Get URL | <1 second | <3 seconds | <5 seconds |
| List spaces | <2 seconds | <5 seconds | <8 seconds |

**Rationale**: Current `ReliableConfluenceClient` averages 4-6s, acceptable for non-interactive operations

**Validation**: Performance tests with real Confluence API

**Priority**: P0 (User experience critical)

---

### NFR-2: Reliability - Success Rate SLO

**Requirement**: High success rate with graceful failure handling

**SLO Targets**:
- **Success Rate**: >99% (excluding user errors like invalid space)
- **Error Budget**: <1% failures per month (~7 failed operations at 1000 ops/month)
- **Retry Success**: >80% of transient failures recover after retry

**Failure Categories**:
1. **Transient Failures**: Network timeouts, 503 errors → RETRY
2. **Client Errors**: Invalid space, missing auth → FAIL FAST with clear error
3. **Server Errors**: 500 errors → RETRY with exponential backoff

**Validation**: Reliability tests with fault injection

**Priority**: P0 (Reliability is core requirement)

---

### NFR-3: Error Handling - Clear Error Messages

**Requirement**: Failures return actionable error messages

**Error Message Format**:
```python
ConfluenceError: Failed to create page "IaC Strategy" in space "Orro"
Reason: Space "Orro" not found or inaccessible
Suggestion: Verify space key with list_spaces()
API Response: 404 - Space does not exist
```

**Required Information**:
- ✅ What operation failed (create page, update, etc.)
- ✅ What was attempted (space, title)
- ✅ Why it failed (API error, validation error)
- ✅ What to do next (actionable suggestion)

**Priority**: P0 (Essential for debugging)

---

### NFR-4: Observability - Metrics & Logging

**Requirement**: Track success/failure rates and performance

**Metrics** (inherit from `ReliableConfluenceClient`):
- Request count (total, success, failure)
- Latency distribution (P50, P95, P99)
- Error rate by category (transient, client, server)
- Circuit breaker state

**Logging**:
- INFO: Successful operations with URL
- WARNING: Retry attempts
- ERROR: Failed operations with full context

**Priority**: P1 (Useful for monitoring)

---

## Reliability Requirements (SRE)

### RR-1: Retry Logic

**Requirement**: Automatic retry for transient failures

**Current Implementation** (from `ReliableConfluenceClient`):
- **Max Retries**: 3 attempts
- **Backoff Strategy**: Exponential (1s, 2s, 4s)
- **Retryable Errors**: 503, 504, connection timeouts, rate limits
- **Non-Retryable**: 400, 401, 403, 404 (fail fast)

**Validation**: Reliability tests with mocked transient failures

**Priority**: P0 (Inherited from underlying client)

---

### RR-2: Circuit Breaker

**Requirement**: Prevent cascading failures with circuit breaker

**Current Implementation** (from `ReliableConfluenceClient`):
- **Failure Threshold**: 5 consecutive failures
- **Timeout**: 60 seconds (circuit open period)
- **Half-Open**: Try one request after timeout
- **States**: Closed (normal), Open (fail fast), Half-Open (testing)

**Behavior**:
- Circuit **CLOSED**: Normal operation, failures tracked
- Circuit **OPEN**: Fail fast without API call (return cached error)
- Circuit **HALF-OPEN**: Allow one request to test recovery

**Validation**: Reliability tests with repeated failures

**Priority**: P0 (Inherited from underlying client)

---

### RR-3: Timeout Management

**Requirement**: Prevent hanging operations

**Timeouts**:
- **Connection Timeout**: 10 seconds (TCP connection establishment)
- **Read Timeout**: 30 seconds (waiting for API response)
- **Total Request Timeout**: 45 seconds (connection + read + processing)

**Behavior on Timeout**:
- Log timeout error
- Increment failure counter (circuit breaker)
- Retry if transient (up to 3 times)
- Fail with clear timeout error message

**Priority**: P0 (Essential for reliability)

---

### RR-4: Concurrent Request Safety

**Requirement**: Handle concurrent page creation safely

**Scenarios**:
1. **10 concurrent creates to same space**: All succeed (no race conditions)
2. **5 concurrent updates to same page**: All succeed with version increment (Confluence handles conflicts)
3. **Mixed creates/updates**: No deadlocks, all complete within 2x normal latency

**Validation**: Reliability test with concurrent requests

**Priority**: P1 (Important for agent use)

---

## Multi-Site Support Requirements

### MSR-1: Configuration-Driven Site Selection

**Requirement**: Support multiple Confluence instances via config

**Configuration File**: `~/.maia/confluence_sites.json`
```json
{
  "default": {
    "url": "https://vivoemc.atlassian.net/wiki",
    "auth": "env:CONFLUENCE_API_TOKEN",
    "primary": true
  },
  "orro": {
    "url": "https://orro.atlassian.net/wiki",
    "auth": "env:ORRO_CONFLUENCE_TOKEN",
    "primary": false
  }
}
```

**Usage**:
```python
# Default site
client = ConfluenceClient()  # Uses "default"

# Orro site
client = ConfluenceClient(site_name="orro")
```

**Acceptance Criteria**:
- ✅ Config file loads on init
- ✅ Missing config falls back to hardcoded default
- ✅ Invalid site_name raises clear error
- ✅ Environment variable auth token resolution

**Priority**: P0 (Future-proof design)

---

### MSR-2: Site Isolation

**Requirement**: Operations isolated to selected site

**Acceptance Criteria**:
- ✅ Client instance bound to one site (immutable)
- ✅ URL returns include correct site domain
- ✅ No cross-site operations (separate client needed)

**Priority**: P0 (Security requirement)

---

### MSR-3: Migration Path

**Requirement**: Adding 2nd site requires zero code changes

**Acceptance Criteria**:
- ✅ Add site to config file
- ✅ Set environment variable for auth
- ✅ Use `site_name` parameter
- ✅ All existing code continues to work (uses "default")

**Migration Steps** (when 2nd site available):
1. Create config file if doesn't exist
2. Add new site entry
3. Set environment variable: `export ORRO_CONFLUENCE_TOKEN=...`
4. Test: `ConfluenceClient(site_name="orro").list_spaces()`

**Priority**: P0 (Key design goal)

---

## Design Constraints

### DC-1: Backward Compatibility

**Requirement**: Don't break existing `ReliableConfluenceClient` usage

**Approach**:
- Wrap `ReliableConfluenceClient` (don't modify)
- Rename to `_reliable_confluence_client.py` (signal internal)
- Keep all existing functionality intact

**Priority**: P0 (Safety requirement)

---

### DC-2: Simplicity Over Features

**Philosophy**: 95% of use cases with 5% of complexity

**Trade-offs**:
- ✅ Simple: One function for create/update
- ❌ Complex: Separate functions for create vs update
- ✅ Simple: Standard markdown library
- ❌ Complex: Custom markdown parser with Confluence extensions
- ✅ Simple: String URL returns
- ❌ Complex: Rich response objects

**Priority**: P0 (Core design philosophy)

---

### DC-3: Fail Fast on Invalid Input

**Requirement**: Validate input before API call

**Validations**:
- Space key: Non-empty string
- Title: Non-empty string, <255 characters
- Markdown: Non-empty string
- Site name: Exists in config

**Behavior**: Raise `ValueError` immediately (don't waste API call)

**Priority**: P1 (UX improvement)

---

## Test Requirements

### TR-1: Test Coverage

**Requirement**: >90% code coverage, 100% critical path

**Critical Paths** (must have 100% coverage):
1. Create page from markdown (happy path)
2. Update page with automatic lookup
3. Error handling (invalid space, network failure)
4. Multi-site configuration loading

**Non-Critical** (can be <90%):
- Edge cases (very long titles, unusual markdown)
- Deprecated methods (if any)

**Priority**: P0 (TDD requirement)

---

### TR-2: Test Categories

**Distribution**:
- **Unit Tests** (30%): 4 tests - isolated logic, no API calls
- **Integration Tests** (40%): 6 tests - end-to-end with live Confluence
- **Reliability Tests** (20%): 4 tests - retry, circuit breaker, concurrency
- **Multi-Site Tests** (10%): 2 tests - config loading, site switching

**Total**: 16 tests covering all scenarios

**Priority**: P0 (TDD requirement)

---

## Rollback Strategy

### RS-1: Fallback to Direct Client Usage

**Scenario**: New `confluence_client.py` has critical bug

**Rollback Plan**:
1. Update agent to use `_reliable_confluence_client.py` directly
2. Document direct usage pattern in agent docs
3. Fix bug in `confluence_client.py`
4. Re-test with integration suite
5. Re-deploy corrected version

**Recovery Time**: <30 minutes (agent doc update only)

**Priority**: P0 (Risk mitigation)

---

### RS-2: Keep Internal Tool Available

**Requirement**: Don't delete underlying client

**Approach**:
- Rename `reliable_confluence_client.py` → `_reliable_confluence_client.py`
- Leading underscore signals "internal only"
- Keep fully functional as fallback

**Priority**: P0 (Safety net)

---

## Success Criteria

### SC-1: Technical Validation

**Criteria**:
- ✅ All 16 tests passing
- ✅ >90% code coverage
- ✅ Zero linting errors
- ✅ Integration test with live Confluence succeeds
- ✅ Performance tests meet SLO targets

**Validation**: Automated test suite + manual testing

---

### SC-2: Operational Validation

**Criteria**:
- ✅ Agent uses correct tool on first attempt (no trial & error)
- ✅ First 10 operations succeed (100% success rate)
- ✅ Zero debugging sessions required
- ✅ Quick start guide sufficient for common operations

**Validation**: Real-world usage + user feedback

---

### SC-3: Documentation Validation

**Criteria**:
- ✅ Quick start guide covers 95% of use cases
- ✅ Error messages actionable and clear
- ✅ Multi-site setup documented
- ✅ Agent documentation updated

**Validation**: Documentation review + usability testing

---

## Requirements Summary

**Total Requirements**: 26 requirements across 7 categories

**Breakdown**:
- Functional: 6 requirements (5 P0, 1 P2)
- Non-Functional: 4 requirements (3 P0, 1 P1)
- Reliability: 4 requirements (3 P0, 1 P1)
- Multi-Site: 3 requirements (3 P0)
- Design Constraints: 3 requirements (2 P0, 1 P1)
- Test: 2 requirements (2 P0)
- Rollback: 2 requirements (2 P0)

**P0 (Critical)**: 20 requirements (77%)
**P1 (Important)**: 5 requirements (19%)
**P2 (Nice to have)**: 1 requirement (4%)

---

## Next Steps

**Phase 1**: Test Design (1.5 hours)
- Write 16 test cases based on these requirements
- Set up test infrastructure (fixtures, mocks)
- Validate tests fail (no implementation yet)

**Approval Required**: Do these requirements match expectations?
- Behavior for duplicate pages (auto-update vs fail)
- Markdown extensions (tables, code blocks sufficient?)
- Multi-site config approach (file vs environment variables)
- Latency targets (5-10s acceptable?)
