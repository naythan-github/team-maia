#!/bin/bash
# Enhanced user-prompt-submit hook with aggressive context validation
# KAI-style Layer 2 enforcement for Maia context loading

# Dynamic MAIA_ROOT detection (portable across environments)
MAIA_ROOT="$(cd "$(dirname "$0")/../.." && pwd)"

# PHASE 126: Exempt /compact and internal commands from hook validation
# Auto-compaction and internal Claude operations should not trigger validation
if [[ "$CLAUDE_USER_MESSAGE" =~ ^/compact$ ]] || [[ "$CLAUDE_USER_MESSAGE" =~ ^/internal ]]; then
    exit 0  # Skip all validation for compaction and internal commands
fi

echo ""
echo "ğŸš¨ğŸš¨ğŸš¨ MAIA UFC ENFORCEMENT - CRITICAL FOUNDATION ğŸš¨ğŸš¨ğŸš¨"
echo "âš¡âš¡âš¡ UFC SYSTEM MANDATORY - NO EXCEPTIONS âš¡âš¡âš¡"
echo ""
echo "ğŸ”´ğŸ”´ğŸ”´ VIOLATION WARNING ğŸ”´ğŸ”´ğŸ”´"
echo "Starting WITHOUT UFC = SYSTEM FAILURE"
echo "The UFC system defines HOW all other context works"
echo ""

# Stage 0: Context Loading Enforcement (NEW)
echo "ğŸ”’ CONTEXT LOADING ENFORCEMENT ACTIVE..."
CONTEXT_ENFORCER="$(dirname "$0")/context_loading_enforcer.py"
if [[ -f "$CONTEXT_ENFORCER" ]]; then
    ENFORCEMENT_RESULT=$(python3 "$CONTEXT_ENFORCER" check 2>&1)
    ENFORCEMENT_CODE=$?
    if [[ $ENFORCEMENT_CODE -ne 0 ]]; then
        echo "$ENFORCEMENT_RESULT"
        echo ""
        echo "ğŸš¨ BLOCKING RESPONSE UNTIL CONTEXT LOADED ğŸš¨"
        exit 1
    else
        echo "âœ… Context loading compliance verified"
    fi
else
    echo "âš ï¸  Context enforcer not found - using legacy validation"
fi
echo ""

# Stage 0.5: LLM Router Cost Protection (NEW)
echo "ğŸ’° LLM ROUTER COST PROTECTION ACTIVE..."
ROUTER_HEALTH_MONITOR="$MAIA_ROOT/claude/tools/ğŸ› ï¸_general/llm_router_health_monitor.py"
if [[ -f "$ROUTER_HEALTH_MONITOR" ]]; then
    # Check if this might be a code-related prompt that could benefit from local models
    # Read the prompt from stdin if available (simplified check)
    ROUTER_STATUS=$(python3 "$ROUTER_HEALTH_MONITOR" protect 2>&1)
    ROUTER_CODE=$?
    if [[ $ROUTER_CODE -ne 0 ]]; then
        echo "$ROUTER_STATUS"
        echo ""
        echo "âš ï¸ ROUTER NOT FUNCTIONAL - HIGH COST RISK FOR CODE TASKS"
        echo "ğŸ’¡ Run 'python3 $ROUTER_HEALTH_MONITOR repair' to attempt auto-fix"
        echo "ğŸ“Š Or run 'python3 $ROUTER_HEALTH_MONITOR check' for detailed status"
        echo ""
        echo "Continue with expensive models? [y/N] (automatically continuing in 3 seconds)"
        # Note: In practice, this would need interactive input handling
        sleep 3
    else
        echo "âœ… Router cost protection verified"
    fi
else
    echo "âš ï¸  Router health monitor not found - no cost protection"
fi
echo ""

# Stage 0.7: Automated Capability Check (Phase 119 - Capability Amnesia Fix)
echo "ğŸ” AUTOMATED CAPABILITY CHECK (Phase 0)..."
CAPABILITY_ENFORCER="$(dirname "$0")/capability_check_enforcer.py"
if [[ -f "$CAPABILITY_ENFORCER" && -n "$CLAUDE_USER_MESSAGE" ]]; then
    CAPABILITY_CHECK=$(python3 "$CAPABILITY_ENFORCER" "$CLAUDE_USER_MESSAGE" 2>&1)
    CAPABILITY_CODE=$?

    if [[ $CAPABILITY_CODE -eq 1 ]]; then
        # Existing capability found with high confidence
        echo "$CAPABILITY_CHECK"
        echo ""
        echo "â¸ï¸  PAUSING: Review existing capability before building new"
        echo "   Maia will ask for confirmation before proceeding."
    elif [[ $CAPABILITY_CODE -eq 0 ]]; then
        echo "âœ… No duplicate capability detected (or low confidence match)"
    else
        echo "âš ï¸  Capability check encountered error - manual Phase 0 check recommended"
    fi
else
    echo "âš ï¸  Capability enforcer not available or no user message"
    echo "   Manual Phase 0 check recommended for build requests"
fi
echo ""

# Stage 0.8: Intelligent Agent Routing (Phase 121 - Automatic Specialist Engagement)
echo "ğŸ¯ INTELLIGENT AGENT ROUTING..."
COORDINATOR_CLI="$(dirname "$0")/../tools/orchestration/coordinator_agent.py"
ROUTING_LOGGER="$(dirname "$0")/../tools/orchestration/routing_decision_logger.py"

if [[ -f "$COORDINATOR_CLI" && -n "$CLAUDE_USER_MESSAGE" ]]; then
    ROUTING_RESULT=$(python3 "$COORDINATOR_CLI" classify "$CLAUDE_USER_MESSAGE" 2>&1)
    ROUTING_CODE=$?

    if [[ $ROUTING_CODE -eq 0 ]]; then
        echo "$ROUTING_RESULT"
        echo ""
        echo "ğŸ’¡ Maia will consider this routing suggestion (can override if context suggests otherwise)"

        # Phase 122: Log routing suggestion
        if [[ -f "$ROUTING_LOGGER" ]]; then
            # Extract routing data and log to database
            python3 "$COORDINATOR_CLI" classify "$CLAUDE_USER_MESSAGE" --log 2>/dev/null || true
        fi
    elif [[ $ROUTING_CODE -eq 2 ]]; then
        # No specific agent needed - general query
        echo "âœ… General query - no specific agent routing needed"
    else
        echo "âš ï¸  Routing classification unavailable - Maia will select agents based on full context"
    fi
else
    echo "âš ï¸  Coordinator not available - manual agent selection"
fi
echo ""

# Stage 1: Validate UFC FIRST (most critical file)
UFC_FILE="$MAIA_ROOT/claude/context/ufc_system.md"
if [[ -f "$UFC_FILE" ]]; then
    echo "ğŸš¨ UFC SYSTEM: âœ… ACCESSIBLE - MUST LOAD FIRST"
else
    echo "ğŸš¨ UFC SYSTEM: âŒ MISSING - CRITICAL SYSTEM FAILURE"
    echo "CANNOT PROCEED WITHOUT UFC SYSTEM"
    exit 1
fi

# Stage 1b: Validate other context files
CONTEXT_FILES=(
    "$MAIA_ROOT/claude/context/core/identity.md"
    "$MAIA_ROOT/claude/context/core/systematic_thinking_protocol.md"
    "$MAIA_ROOT/claude/context/tools/available.md"
    "$MAIA_ROOT/claude/context/core/agents.md"
    "$MAIA_ROOT/claude/context/core/command_orchestration.md"
    "$MAIA_ROOT/claude/context/personal/profile.md"
)

echo "ğŸ” VALIDATING CONTEXT FILE ACCESSIBILITY..."
VALIDATION_FAILED=false

for file in "${CONTEXT_FILES[@]}"; do
    if [[ -f "$file" ]]; then
        echo "  âœ… $(basename "$file") - accessible"
    else
        echo "  âŒ $(basename "$file") - MISSING OR INACCESSIBLE"
        VALIDATION_FAILED=true
    fi
done

# Stage 2: Force context loading reminder with UFC priority
echo ""
echo "âš¡ MANDATORY CONTEXT LOADING SEQUENCE âš¡"
echo ""
echo "ğŸš¨ğŸš¨ğŸš¨ STEP 1 - NON-NEGOTIABLE ğŸš¨ğŸš¨ğŸš¨"
echo "   ğŸ—ï¸  UFC SYSTEM: $MAIA_ROOT/claude/context/ufc_system.md"
echo "   âš ï¸  THIS DEFINES THE ENTIRE CONTEXT ARCHITECTURE - LOAD FIRST!"
echo ""
echo "ğŸ”„ THEN load remaining core files:"
echo "   2. ğŸ¤– Identity (who you are as Maia)"
echo "   3. ğŸ§  Systematic Thinking Protocol (MANDATORY optimization framework)"
echo "   4. ğŸ› ï¸  Tools Available (capabilities and commands)"
echo "   5. ğŸ‘¥ Agents (specialized agent orchestration)"
echo "   6. ğŸ”— Command Orchestration (advanced multi-agent workflows)"
echo "   7. ğŸ‘¤ Personal Profile (user context and preferences)"
echo ""

# Stage 3: Validation checkpoint
if [[ "$VALIDATION_FAILED" == true ]]; then
    echo "ğŸš¨ CONTEXT VALIDATION FAILED ğŸš¨"
    echo "âŒ Some context files are missing or inaccessible"
    echo "âš ï¸  OPERATING IN DEGRADED MODE - CONTEXT MAY BE INCOMPLETE"
else
    echo "âœ… CONTEXT VALIDATION PASSED"
    echo "ğŸ¯ ALL CONTEXT FILES ACCESSIBLE - PROCEED WITH FULL CONTEXT LOADING"
fi

echo ""
echo "ğŸ¤– Maia Context Enforcement: ACTIVE"
echo "ğŸ“Š Expected Response Format:"
echo "   âœ… Context loaded. Ready to assist as Maia."
echo "   ğŸ“Š Context Status: [7/7 files loaded including Systematic Thinking Protocol]"
echo "   ğŸ¯ Operating Mode: Full Context + Systematic Optimization Framework"
echo "   ğŸ§  Thinking Mode: Engineering Leadership Systematic Optimization (MANDATORY)"
echo "   ğŸ“ˆ Context Confidence: 100%"
echo ""
echo "âš ï¸  FAILURE TO LOAD CONTEXT = DEGRADED MODE OPERATION"
echo "ğŸ”„ RETRY REQUIRED IF ANY CONTEXT FILES FAIL TO LOAD"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "ğŸ¯ BEGIN MANDATORY CONTEXT LOADING SEQUENCE NOW"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# Stage 5: Model Selection Guidance and Token Usage Tracking
echo ""
echo "ğŸ§  MODEL SELECTION GUIDANCE (Cost Optimization Active)..."

# Check if we can detect current model (this is aspirational - may not work in all environments)
CURRENT_MODEL="Unknown"
if [[ -n "$CLAUDE_MODEL" ]]; then
    CURRENT_MODEL="$CLAUDE_MODEL"
elif [[ -n "$MODEL" ]]; then
    CURRENT_MODEL="$MODEL"
fi

echo "   ğŸ“Š Current Session Model: $CURRENT_MODEL"
echo "   âš¡ Recommended Default: Sonnet (90% of tasks)"
echo "   ğŸ¯ Target Cost Reduction: 50-60% vs previous Opus usage"
echo ""
echo "ğŸ“ MODEL SELECTION STRATEGY:"
echo "   âœ… Sonnet: Complex workflows, agent orchestration, decision-making"
echo "   âš¡ Haiku: Simple operations, data retrieval, template generation"
echo "   ğŸ¯ Opus: REQUIRES PERMISSION - High-stakes reasoning, 6+ agent orchestration"
echo ""
echo "âš ï¸  OPUS PROTOCOL REMINDER:"
echo "   1. Maia must ask: 'Would you like me to use Opus for [specific benefit]?'"
echo "   2. Wait for explicit user confirmation"
echo "   3. Default to Sonnet if no response"
echo ""

# Token usage tracking (basic implementation)
USAGE_LOG="$MAIA_ROOT/claude/data/model_usage_log.txt"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# Create usage log if it doesn't exist
if [[ ! -f "$USAGE_LOG" ]]; then
    mkdir -p "$(dirname "$USAGE_LOG")"
    echo "# Maia Model Usage Tracking Log" > "$USAGE_LOG"
    echo "# Format: timestamp,model,session_start" >> "$USAGE_LOG"
fi

# Log session start
echo "$TIMESTAMP,$CURRENT_MODEL,session_start" >> "$USAGE_LOG"

# Show recent usage summary (last 7 days)
echo "ğŸ“ˆ RECENT TOKEN USAGE SUMMARY:"
if command -v tail >/dev/null && command -v wc >/dev/null; then
    RECENT_SESSIONS=$(tail -100 "$USAGE_LOG" 2>/dev/null | grep -v "^#" | wc -l | tr -d ' ')
    echo "   ğŸ“Š Recent Sessions: $RECENT_SESSIONS"

    # Count model usage in recent sessions
    SONNET_COUNT=$(tail -100 "$USAGE_LOG" 2>/dev/null | grep -i sonnet | wc -l | tr -d ' ')
    OPUS_COUNT=$(tail -100 "$USAGE_LOG" 2>/dev/null | grep -i opus | wc -l | tr -d ' ')

    echo "   âš¡ Sonnet Usage: $SONNET_COUNT sessions"
    echo "   ğŸ¯ Opus Usage: $OPUS_COUNT sessions"

    if [[ $OPUS_COUNT -gt 0 && $SONNET_COUNT -gt 0 ]]; then
        echo "   ğŸ’° Cost Efficiency: Tracking active"
    fi
else
    echo "   ğŸ“Š Usage tracking initialized"
fi

echo ""

# Stage 4: Model Enforcement and Cost Protection
echo ""
echo "ğŸ”’ MODEL ENFORCEMENT AND COST PROTECTION..."

# Check for continue commands that often trigger Opus usage
if [[ "${CLAUDE_USER_MESSAGE,,}" =~ ^(continue|cont|more|keep going|carry on|finish|complete|elaborate|expand|detail) ]]; then
    echo "ğŸš¨ CONTINUE/COMPLETION COMMAND DETECTED"
    echo "   ğŸ’¡ These commands often trigger unwanted Opus usage"
    echo "   ğŸ”’ Enforcing Sonnet to prevent cost escalation"
    
    # Run continue command protection
    source "$(dirname "$0")/continue-command-protection.sh"
fi

# Run model enforcement check
if [[ -n "$CLAUDE_USER_MESSAGE" ]]; then
    MODEL_ENFORCEMENT=$(python3 "$(dirname "$0")/model_enforcement_webhook.py" --check-task "$CLAUDE_USER_MESSAGE" 2>/dev/null || echo "")
    if [[ -n "$MODEL_ENFORCEMENT" ]]; then
        echo "$MODEL_ENFORCEMENT"
    fi
fi

# Stage 5.5: Systematic Thinking Enforcement Reminder
echo ""
echo "ğŸ§  SYSTEMATIC THINKING ENFORCEMENT ACTIVE..."
echo "   ğŸ“‹ Every response MUST follow systematic optimization framework:"
echo "   ğŸ” Phase 0: Capability Check (search existing solutions FIRST) â­ NEW"
echo "   ğŸ” Phase 1: Problem Analysis (stakeholders, constraints, success criteria)"
echo "   ğŸ’¡ Phase 2: Solution Exploration (minimum 2-3 approaches with trade-offs)"
echo "   âœ… Phase 3: Optimized Implementation (validation, risks, success metrics)"
echo ""
echo "   âš ï¸  ENFORCEMENT: Responses that jump to solutions will be flagged"
echo "   ğŸ¯ REQUIREMENT: Visible reasoning chains and systematic analysis"
echo "   ğŸ“Š SCORING: Systematic thinking compliance monitored and tracked"

echo ""

# Stage 0.6: Capability Check Protocol Reminder
echo "ğŸ” PHASE 0: CAPABILITY CHECK PROTOCOL ACTIVE..."
echo "   ğŸ“š Before recommending solutions, search existing capabilities:"
echo "   ğŸ“‡ capability_index.md: ALWAYS-LOADED registry (200+ tools, 49 agents) â­ SEARCH HERE FIRST"
echo "   ğŸ“‹ SYSTEM_STATE.md: Recent work details (intent-aware phases)"
echo "   ğŸ” capability_checker.py: Deep search tool (if index search insufficient)"
echo ""
echo "   âš ï¸  ANTI-DUPLICATION: Check capability_index.md FIRST via Cmd/Ctrl+F"
echo "   âœ… USE EXISTING when found, enhance when partial match"
echo "   ğŸš¨ DOCUMENT justification if building new vs extending existing"
echo ""

# Stage 5: Tool Usage Logging and Enhanced Discovery Enforcement
echo ""
echo "ğŸ”§ TOOL USAGE MONITORING AND DISCOVERY ENFORCEMENT..."

# Log tool usage patterns and provide domain-specific guidance
if [[ -n "$CLAUDE_USER_MESSAGE" ]]; then
    # Tool usage logging
    python3 "$(dirname "$0")/tool_usage_logger.py" "$CLAUDE_USER_MESSAGE" 2>/dev/null || echo "ğŸ“Š Tool usage monitoring initialized"

    # Enhanced tool discovery enforcement
    TOOL_CHECK_RESULT=$(python3 "$(dirname "$0")/tool_discovery_enforcer.py" "$CLAUDE_USER_MESSAGE" 2>/dev/null || echo "")
    if [[ -n "$TOOL_CHECK_RESULT" ]]; then
        echo "$TOOL_CHECK_RESULT"
        echo ""
        echo "âš¡ RUNTIME VALIDATION ACTIVE:"
        echo "   ğŸ” All tool selections will be validated against available specialized tools"
        echo "   ğŸš¨ Generic tools blocked when specialized alternatives exist"
        echo "   ğŸ’¡ Best tool suggestions provided automatically"
    fi
else
    echo "ğŸ” Enhanced tool discovery will check for:"
    echo "   ğŸ¯ Research Domain â†’ Researcher Agent, Holiday Research Agent, Company Research Agent"
    echo "   ğŸ’¼ Job Search Domain â†’ Jobs Agent, LinkedIn Optimizer, Interview Prep Agent"
    echo "   ğŸ’° Financial Domain â†’ Financial Advisor Agent, Financial Planner Agent"
    echo "   ğŸ”’ Security Domain â†’ Security Specialist Agent, Local Security Scanner"
    echo "   ğŸ“ Content Domain â†’ Blog Writer Agent, LinkedIn AI Advisor"
    echo "   ğŸ”§ Technical Domain â†’ Azure Architect Agent, Developer Agent"
fi

# Stage 6: Conversation Detection (Phase 102) - Passive monitoring
# Note: Lightweight check only - main detection happens via Maia responses
echo ""
echo "ğŸ’¾ CONVERSATION PERSISTENCE ACTIVE (Phase 102)..."
echo "   ğŸ“Š Automatic detection of significant conversations"
echo "   ğŸ’¡ Will prompt to save important discussions"
echo "   ğŸ”§ Use /save-conversation for manual save anytime"

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
