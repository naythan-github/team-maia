# Azure AD App Registration Guide for Microsoft 365 Integration

**Generated by**: CodeLlama 13B (local LLM - 99.3% cost savings)
**For**: Maia M365 Graph MCP Server
**Target**: Orro Group Organizational Account

## Prerequisites

- [ ] Azure Portal access: https://portal.azure.com
- [ ] Azure AD admin permissions for Orro Group tenant
- [ ] Organizational account: @orro.com.au

## Step-by-Step Registration

### 1. Navigate to Azure AD
1. Sign in to your Azure portal
2. Navigate to the Azure Active Directory dashboard
3. Click on "App registrations" in the left-hand menu

### 2. Create New Registration
1. Click "New registration"
2. Provide app details:
   - **Name**: `Maia M365 Integration`
   - **Supported account types**: "Accounts in this organizational directory only (Orro Group)"
   - **Redirect URI**:
     - Type: Public client/native
     - URI: `http://localhost`

3. Click "Register"

### 3. Note Application Credentials
After registration, copy these values (needed for .env configuration):

- [ ] **Application (client) ID**: `________________________________`
- [ ] **Directory (tenant) ID**: `________________________________`

**Save these immediately** - you'll need them for M365_CLIENT_ID and M365_TENANT_ID

### 4. Configure API Permissions
1. Navigate to "API permissions" tab
2. Click "Add a permission"
3. Select "Microsoft Graph"
4. Select "Delegated permissions"
5. Add the following permissions:

**Required Permissions:**
- [ ] `Mail.ReadWrite` - Read and write mail
- [ ] `Calendars.ReadWrite` - Read and write calendar events
- [ ] `Team.ReadBasic.All` - Read basic Teams information
- [ ] `ChannelMessage.Send` - Send messages to Teams channels
- [ ] `OnlineMeetings.ReadWrite` - Create and manage online meetings
- [ ] `User.Read` - Sign in and read user profile

6. Click "Add permissions"

### 5. Grant Admin Consent (Critical!)
1. After adding all permissions, click "Grant admin consent for Orro Group"
2. Confirm the action
3. Verify all permissions show green checkmarks with "Granted for Orro Group"

**⚠️ Without admin consent, the app will fail to authenticate!**

### 6. Create Client Secret (Optional - for service accounts)
If using client secret authentication instead of device code flow:

1. Navigate to "Certificates & secrets"
2. Click "New client secret"
3. Provide:
   - **Description**: `Maia M365 MCP Server`
   - **Expires**: 12 months (recommended for production)
4. Click "Add"
5. **IMMEDIATELY COPY THE SECRET VALUE** - it won't be shown again!
   - Secret Value: `________________________________`

### 7. Configure Environment Variables

Edit your `.env` file:

```bash
# Required
export M365_TENANT_ID="your-tenant-id-from-step-3"
export M365_CLIENT_ID="your-client-id-from-step-3"

# Optional: for read-only testing
export M365_READ_ONLY="true"

# Optional: for service account authentication
export M365_CLIENT_SECRET="your-client-secret-from-step-6"
```

Load configuration:
```bash
source ~/.maia/config/m365/.env
```

### 8. Test Authentication

#### Device Code Flow (Default - Interactive)
```bash
python3 /Users/naythandawe/git/maia/claude/tools/mcp/m365_graph_server.py
```

Expected output:
```
M365 Graph Client initialized (read_only=True)
Using device code authentication (interactive)
Please go to https://microsoft.com/devicelogin and enter code: XXXXXXXX
```

#### Verify Permissions
After authentication, test basic operations:

```bash
# Test email access
# (Should list your inbox messages if permissions are correct)

# Test Teams access
# (Should list your Teams if permissions are correct)

# Test Calendar access
# (Should list upcoming meetings if permissions are correct)
```

### 9. Troubleshooting

**Error: "AADSTS65001: The user or administrator has not consented"**
- Solution: Ensure admin consent was granted (Step 5)
- Re-run: "Grant admin consent for Orro Group"

**Error: "AADSTS700016: Application not found in directory"**
- Solution: Check tenant ID matches your Orro Group tenant
- Verify: Application ID is correct

**Error: "Insufficient privileges to complete the operation"**
- Solution: Add missing API permissions (Step 4)
- Verify: All required permissions are granted

**Device code expired**
- Solution: Codes expire after 15 minutes
- Action: Re-run authentication to get new code

**Teams/Channel permissions denied**
- Solution: Ensure using `--org-mode` flag (organizational account)
- Verify: Not using personal Microsoft account

### 10. Production Deployment Checklist

- [ ] All API permissions configured and granted
- [ ] Admin consent completed for Orro Group
- [ ] Environment variables configured in secure location
- [ ] Test with read-only mode first (`M365_READ_ONLY=true`)
- [ ] Verify all operations (email, Teams, calendar) work
- [ ] Document client secret securely (if using)
- [ ] Set up credential rotation schedule (12-month expiry)
- [ ] Configure MCP server in Claude Code settings
- [ ] Test Microsoft 365 Integration Agent workflows

## Security Best Practices

1. **Credential Storage**: Use encrypted environment variables via `mcp_env_manager.py`
2. **Read-Only Testing**: Always test with `M365_READ_ONLY=true` first
3. **Client Secret Rotation**: Rotate secrets before expiry (set calendar reminder)
4. **Least Privilege**: Only request permissions actually needed
5. **Audit Logging**: Monitor authentication logs in Azure AD

## Next Steps

After successful registration:

1. **Configure MCP Server**: Add to Claude Code MCP configuration
2. **Test Integration**: Run M365 Integration Agent commands
3. **Enable Automation**: Configure morning briefings, email intelligence
4. **Monitor Usage**: Track API calls and costs in Azure portal

## Support

- **Azure AD Documentation**: https://docs.microsoft.com/azure/active-directory/
- **Microsoft Graph API**: https://docs.microsoft.com/graph/
- **Maia M365 Agent**: `claude/agents/microsoft_365_integration_agent.md`
- **Setup Script**: `claude/tools/mcp/setup_m365_mcp.sh`

---

**Generated with Local LLM (CodeLlama 13B) - 99.3% cost savings vs Claude Sonnet**
