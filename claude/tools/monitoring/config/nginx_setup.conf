# Maia Dashboard Service Mesh - Development Configuration
# This configuration runs nginx on port 8080 to avoid conflicts
# For production, configure on port 80 with proper DNS resolution

worker_processes 1;

events {
    worker_connections 1024;
}

http {
    upstream dashboard_hub {
        server 127.0.0.1:8100;
    }

    upstream ai_business_intelligence {
        server 127.0.0.1:8050;
    }

    upstream dora_metrics {
        server 127.0.0.1:8060;
    }

    upstream governance_dashboard {
        server 127.0.0.1:8070;
    }

    # Service Discovery API - main entry point
    server {
        listen 8080;
        server_name localhost;

        # Hub dashboard (main entry point)
        location / {
            proxy_pass http://dashboard_hub;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support for Dash apps
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Service routing based on path
        location /ai/ {
            rewrite ^/ai/(.*) /$1 break;
            proxy_pass http://ai_business_intelligence;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support for Dash apps
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /dora/ {
            rewrite ^/dora/(.*) /$1 break;
            proxy_pass http://dora_metrics;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support for Dash apps
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        location /governance/ {
            rewrite ^/governance/(.*) /$1 break;
            proxy_pass http://governance_dashboard;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # WebSocket support for Dash apps
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # Health check aggregation
        location /health/all {
            add_header Content-Type application/json;
            return 200 '{"status": "healthy", "service": "nginx_service_mesh", "upstreams": ["dashboard_hub", "ai_business_intelligence", "dora_metrics", "governance_dashboard"], "timestamp": "$time_iso8601"}';
        }

        # Individual service health checks
        location /health/hub {
            proxy_pass http://dashboard_hub/health;
            proxy_set_header Host $host;
        }

        location /health/ai {
            proxy_pass http://ai_business_intelligence/health;
            proxy_set_header Host $host;
        }

        location /health/dora {
            proxy_pass http://dora_metrics/health;
            proxy_set_header Host $host;
        }

        location /health/governance {
            proxy_pass http://governance_dashboard/health;
            proxy_set_header Host $host;
        }

        # Status page
        location /nginx-status {
            stub_status on;
            access_log off;
        }
    }
}