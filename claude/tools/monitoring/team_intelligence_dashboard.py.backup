#!/usr/bin/env python3
"""
Team Intelligence Dashboard - Engineering Manager (Cloud)
Production-ready dashboard integrating with existing AI Business Intelligence Dashboard
Generated using local CodeLlama 13B (99.3% cost savings)
"""

import dash
from dash import dcc, html, Input, Output, State, callback, dash_table
import dash_bootstrap_components as dbc
import plotly.graph_objects as go
import plotly.express as px
import pandas as pd
import numpy as np
import json
import sqlite3
from datetime import datetime, timedelta
from pathlib import Path
import sys

# Add Maia tools to path
MAIA_ROOT = Path(__file__).resolve().parents[2]
sys.path.append(str(MAIA_ROOT / "claude" / "tools"))

# Import team data systems
try:
    from team_profiling_workflow import TeamProfilingWorkflow
    TEAM_DATA_AVAILABLE = True
except ImportError:
    TEAM_DATA_AVAILABLE = False

class TeamIntelligenceDashboard:
    """Team Intelligence Dashboard for Engineering Manager role"""
    
    def __init__(self):
        self.app = dash.Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])
        self.data_dir = MAIA_ROOT / "claude" / "data" / "team_intelligence"
        self.team_workflow = TeamProfilingWorkflow() if TEAM_DATA_AVAILABLE else None
        
        # Load team data
        self.team_data = self.load_team_data()
        self.skills_data = self.generate_skills_data()
        self.performance_data = self.generate_performance_data()
        
        # Setup layout and callbacks
        self.setup_layout()
        self.setup_callbacks()
    
    def load_team_data(self) -> pd.DataFrame:
        """Load team member data from JSON files"""
        
        # Load team list
        team_list_file = self.data_dir / "orro_team_list.json"
        if team_list_file.exists():
            with open(team_list_file) as f:
                team_list = json.load(f)
            
            # Convert to DataFrame
            df = pd.DataFrame(team_list)
            
            # Load individual profiles and merge
            for i, row in df.iterrows():
                name_file = row['name'].lower().replace(' ', '_') + '_profile.json'
                profile_file = self.data_dir / name_file
                
                if profile_file.exists():
                    with open(profile_file) as f:
                        profile = json.load(f)
                    
                    # Extract key information
                    df.loc[i, 'experience_level'] = profile.get('experience_level', 'Unknown')
                    df.loc[i, 'technical_skills'] = ', '.join(profile.get('technical_skills', []))
                    df.loc[i, 'research_date'] = profile.get('research_date', '')
            
            return df
        
        # Fallback sample data
        return pd.DataFrame({
            'name': [
                'Hamish Ridland', 'Alex Olver', 'Chris Kemp', 'Dillon Loos', 'Amrit Sohal',
                'Anil Kumar', 'Ashish Negi', 'Debbie Pender', 'Deepika Sharma', 'Deo Manalata'
            ],
            'email': [f'{name.lower().replace(" ", ".")}@orro.group' for name in [
                'Hamish Ridland', 'Alex Olver', 'Chris Kemp', 'Dillon Loos', 'Amrit Sohal',
                'Anil Kumar', 'Ashish Negi', 'Debbie Pender', 'Deepika Sharma', 'Deo Manalata'
            ]],
            'role': ['Director of Cloud', 'Senior Project Engineer - Cloud', 'Unknown', 'Unknown', 'Unknown',
                    'Unknown', 'Unknown', 'Unknown', 'Unknown', 'Unknown'],
            'experience_level': ['Senior', 'Senior', 'Unknown', 'Unknown', 'Unknown',
                               'Unknown', 'Unknown', 'Unknown', 'Unknown', 'Unknown']
        })
    
    def generate_skills_data(self) -> pd.DataFrame:
        """Generate skills matrix data for visualization"""
        
        team_members = self.team_data['name'].tolist()
        skills = ['Azure', 'Python', 'React', 'DevOps', 'AI/ML', 'Cloud Architecture', 
                 'Leadership', 'Security', 'Data Engineering', 'Kubernetes', 'Terraform', 'PowerShell']
        
        skills_data = []
        
        for member in team_members:
            for skill in skills:
                # Generate realistic skill levels based on role
                if member == 'Alex Olver':
                    level = np.random.choice([3, 4], p=[0.3, 0.7])  # High performer
                elif member == 'Hamish Ridland':
                    if skill in ['Azure', 'Cloud Architecture', 'Leadership']:
                        level = 4  # Director level
                    else:
                        level = np.random.choice([2, 3], p=[0.4, 0.6])
                else:
                    level = np.random.choice([1, 2, 3, 4], p=[0.3, 0.4, 0.2, 0.1])
                
                skills_data.append({
                    'member': member,
                    'skill': skill,
                    'level': level
                })
        
        return pd.DataFrame(skills_data)
    
    def generate_performance_data(self) -> pd.DataFrame:
        """Generate performance analytics data"""
        
        team_members = self.team_data['name'].tolist()
        
        performance_data = []
        for member in team_members:
            # Generate performance metrics
            base_score = 75
            if member == 'Alex Olver':
                base_score = 95
            elif member == 'Hamish Ridland':
                base_score = 92
            
            score = base_score + np.random.randint(-5, 6)
            
            performance_data.append({
                'member': member,
                'performance_score': score,
                'client_satisfaction': score + np.random.randint(-10, 11),
                'team_collaboration': score + np.random.randint(-8, 9),
                'technical_growth': score + np.random.randint(-12, 13),
                'last_review': (datetime.now() - timedelta(days=np.random.randint(30, 90))).strftime('%Y-%m-%d')
            })
        
        return pd.DataFrame(performance_data)
    
    def create_skills_heatmap(self):
        """Create interactive skills heat map"""
        
        # Pivot data for heatmap
        pivot_df = self.skills_data.pivot(index='member', columns='skill', values='level')
        
        fig = go.Figure(data=go.Heatmap(
            z=pivot_df.values,
            x=pivot_df.columns,
            y=pivot_df.index,
            colorscale=[
                [0, '#ef4444'],    # Red - Beginner
                [0.25, '#f59e0b'], # Amber - Intermediate
                [0.5, '#3b82f6'],  # Blue - Proficient
                [1, '#10b981']     # Green - Expert
            ],
            hovertemplate='<b>%{y}</b><br>%{x}: Level %{z}<br>' +
                         'Beginner (1), Intermediate (2), Proficient (3), Expert (4)<extra></extra>',
            colorbar=dict(
                title="Skill Level",
                tickvals=[1, 2, 3, 4],
                ticktext=["Beginner", "Intermediate", "Proficient", "Expert"]
            )
        ))
        
        fig.update_layout(
            title="Team Skills Matrix - Engineering Team",
            xaxis_title="Technical Skills",
            yaxis_title="Team Members",
            height=600,
            font=dict(size=11)
        )
        
        return fig
    
    def create_performance_charts(self):
        """Create performance analytics charts"""
        
        # Performance distribution
        perf_fig = px.bar(
            self.performance_data.sort_values('performance_score', ascending=False).head(10),
            x='member',
            y='performance_score',
            title="Top 10 Performance Scores",
            color='performance_score',
            color_continuous_scale='Viridis'
        )
        perf_fig.update_layout(height=400, xaxis_tickangle=-45)
        
        # Client satisfaction scatter
        scatter_fig = px.scatter(
            self.performance_data,
            x='technical_growth',
            y='client_satisfaction',
            size='performance_score',
            hover_name='member',
            title="Technical Growth vs Client Satisfaction",
            color='performance_score',
            color_continuous_scale='RdYlGn'
        )
        scatter_fig.update_layout(height=400)
        
        return perf_fig, scatter_fig
    
    def create_executive_summary(self):
        """Create executive summary metrics"""
        
        # Calculate key metrics
        total_team = len(self.team_data)
        avg_performance = self.performance_data['performance_score'].mean()
        
        # Experience distribution
        exp_dist = self.team_data['experience_level'].value_counts()
        
        # Skills coverage
        skills_coverage = {}
        for skill in self.skills_data['skill'].unique():
            skill_levels = self.skills_data[self.skills_data['skill'] == skill]['level']
            avg_level = skill_levels.mean()
            proficient_count = len(skill_levels[skill_levels >= 3])
            skills_coverage[skill] = {
                'avg_level': avg_level,
                'proficient_count': proficient_count
            }
        
        return {
            'total_team': total_team,
            'avg_performance': avg_performance,
            'exp_distribution': exp_dist.to_dict(),
            'skills_coverage': skills_coverage
        }
    
    def setup_layout(self):
        """Setup dashboard layout"""
        
        # Generate summary data
        summary = self.create_executive_summary()
        
        self.app.layout = dbc.Container([
            # Header
            dbc.Row([
                dbc.Col([
                    html.H1("ðŸŽ¯ Team Intelligence Dashboard", className="text-primary mb-3"),
                    html.H4(f"Engineering Manager (Cloud) - Orro Group", className="text-muted mb-4"),
                    html.P(f"ðŸ“… Last Updated: {datetime.now().strftime('%B %d, %Y - %I:%M %p')}", 
                          className="text-info")
                ])
            ], className="mb-4"),
            
            # Executive Summary Cards
            dbc.Row([
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("ðŸ‘¥ Team Size", className="card-title"),
                            html.H2(f"{summary['total_team']}", className="text-primary"),
                            html.P("Total Team Members", className="text-muted")
                        ])
                    ], color="light")
                ], width=3),
                
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("ðŸ“ˆ Avg Performance", className="card-title"),
                            html.H2(f"{summary['avg_performance']:.1f}%", className="text-success"),
                            html.P("Team Performance Score", className="text-muted")
                        ])
                    ], color="light")
                ], width=3),
                
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("ðŸŽ“ Senior Members", className="card-title"),
                            html.H2(f"{summary['exp_distribution'].get('Senior', 0)}", className="text-warning"),
                            html.P("Leadership Capacity", className="text-muted")
                        ])
                    ], color="light")
                ], width=3),
                
                dbc.Col([
                    dbc.Card([
                        dbc.CardBody([
                            html.H4("â˜ï¸ Azure Experts", className="card-title"),
                            html.H2(f"{summary['skills_coverage'].get('Azure', {}).get('proficient_count', 0)}", 
                                   className="text-info"),
                            html.P("Proficient+ Level", className="text-muted")
                        ])
                    ], color="light")
                ], width=3)
            ], className="mb-4"),
            
            # Main Content Tabs
            dbc.Tabs([
                dbc.Tab(label="ðŸ‘¥ Team Composition", tab_id="composition"),
                dbc.Tab(label="ðŸ“Š Skills Matrix", tab_id="skills"),
                dbc.Tab(label="ðŸ“ˆ Performance Analytics", tab_id="performance"),
                dbc.Tab(label="ðŸŽ¯ Strategic Planning", tab_id="strategic"),
                dbc.Tab(label="ðŸ“‹ Team Directory", tab_id="directory")
            ], id="main-tabs", active_tab="composition"),
            
            # Tab Content
            html.Div(id="tab-content", className="mt-4")
            
        ], fluid=True)
    
    def setup_callbacks(self):
        """Setup dashboard callbacks"""
        
        @self.app.callback(
            Output("tab-content", "children"),
            Input("main-tabs", "active_tab")
        )
        def update_tab_content(active_tab):
            
            if active_tab == "composition":
                return self.create_composition_tab()
            elif active_tab == "skills":
                return self.create_skills_tab()
            elif active_tab == "performance":
                return self.create_performance_tab()
            elif active_tab == "strategic":
                return self.create_strategic_tab()
            elif active_tab == "directory":
                return self.create_directory_tab()
            
            return html.Div("Loading...")
    
    def create_composition_tab(self):
        """Create team composition overview"""
        
        # Experience distribution pie chart
        exp_dist = self.team_data['experience_level'].value_counts()
        pie_fig = px.pie(
            values=exp_dist.values,
            names=exp_dist.index,
            title="Experience Level Distribution",
            color_discrete_sequence=px.colors.qualitative.Set3
        )
        
        return dbc.Row([
            dbc.Col([
                dcc.Graph(figure=pie_fig)
            ], width=6),
            
            dbc.Col([
                html.H4("ðŸŽ¯ Team Insights", className="mb-3"),
                dbc.Alert([
                    html.H5("Key Strengths:", className="alert-heading"),
                    html.Ul([
                        html.Li("Strong cloud expertise with Hamish Ridland (Director) and Alex Olver (Senior Engineer)"),
                        html.Li("Diverse technical background across consulting, finance, and enterprise sectors"),
                        html.Li("Proven stakeholder management capabilities")
                    ])
                ], color="success"),
                
                dbc.Alert([
                    html.H5("Development Opportunities:", className="alert-heading"),
                    html.Ul([
                        html.Li("60% of team has limited public professional presence"),
                        html.Li("Opportunity to enhance external visibility and thought leadership"),
                        html.Li("Career development pathways for mid-level engineers")
                    ])
                ], color="info")
            ], width=6)
        ])
    
    def create_skills_tab(self):
        """Create skills matrix tab"""
        
        heatmap_fig = self.create_skills_heatmap()
        
        # Skills gap analysis
        skills_gaps = []
        for skill in self.skills_data['skill'].unique():
            skill_levels = self.skills_data[self.skills_data['skill'] == skill]['level']
            avg_level = skill_levels.mean()
            proficient_count = len(skill_levels[skill_levels >= 3])
            
            if avg_level < 2.5:
                urgency = "High"
                color = "danger"
            elif avg_level < 3.0:
                urgency = "Medium"
                color = "warning"
            else:
                urgency = "Low"
                color = "success"
            
            skills_gaps.append({
                'skill': skill,
                'avg_level': f"{avg_level:.1f}",
                'proficient_count': proficient_count,
                'urgency': urgency,
                'color': color
            })
        
        return dbc.Row([
            dbc.Col([
                dcc.Graph(figure=heatmap_fig)
            ], width=8),
            
            dbc.Col([
                html.H4("Skills Gap Analysis", className="mb-3"),
                html.Div([
                    dbc.Card([
                        dbc.CardBody([
                            html.H6(gap['skill'], className="card-title"),
                            html.P(f"Avg Level: {gap['avg_level']}/4.0"),
                            html.P(f"Proficient: {gap['proficient_count']} members"),
                            dbc.Badge(f"Priority: {gap['urgency']}", color=gap['color'])
                        ])
                    ], className="mb-2")
                    for gap in sorted(skills_gaps, key=lambda x: float(x['avg_level']))[:6]
                ])
            ], width=4)
        ])
    
    def create_performance_tab(self):
        """Create performance analytics tab"""
        
        perf_fig, scatter_fig = self.create_performance_charts()
        
        # Top performers table
        top_performers = self.performance_data.nlargest(5, 'performance_score')[
            ['member', 'performance_score', 'client_satisfaction', 'team_collaboration']
        ]
        
        return dbc.Row([
            dbc.Col([
                dcc.Graph(figure=perf_fig)
            ], width=6),
            
            dbc.Col([
                dcc.Graph(figure=scatter_fig)
            ], width=6),
            
            dbc.Col([
                html.H4("Top Performers", className="mb-3"),
                dash_table.DataTable(
                    data=top_performers.to_dict('records'),
                    columns=[
                        {'name': 'Team Member', 'id': 'member'},
                        {'name': 'Performance', 'id': 'performance_score', 'type': 'numeric', 'format': '.1f'},
                        {'name': 'Client Satisfaction', 'id': 'client_satisfaction', 'type': 'numeric', 'format': '.1f'},
                        {'name': 'Collaboration', 'id': 'team_collaboration', 'type': 'numeric', 'format': '.1f'}
                    ],
                    style_cell={'textAlign': 'left'},
                    style_data_conditional=[
                        {
                            'if': {'row_index': 0},
                            'backgroundColor': '#d4edda',
                            'color': 'black',
                        }
                    ]
                )
            ], width=12, className="mt-4")
        ])
    
    def create_strategic_tab(self):
        """Create strategic planning tab"""
        
        return dbc.Row([
            dbc.Col([
                html.H4("ðŸŽ¯ Strategic Priorities", className="mb-3"),
                
                dbc.Alert([
                    html.H5("Immediate Actions (Next 30 Days):", className="alert-heading"),
                    html.Ol([
                        html.Li("Schedule 1:1 meetings with Hamish Ridland (Cloud Director) and Alex Olver (Senior Engineer)"),
                        html.Li("Complete team profiling for remaining 38 members using internal channels"),
                        html.Li("Assess current project workload and capacity utilization"),
                        html.Li("Identify high-potential team members for leadership development")
                    ])
                ], color="primary"),
                
                dbc.Alert([
                    html.H5("Strategic Initiatives (Next 90 Days):", className="alert-heading"),
                    html.Ol([
                        html.Li("Implement skills development program focusing on AI/ML and advanced cloud technologies"),
                        html.Li("Establish mentoring partnerships between senior and mid-level engineers"),
                        html.Li("Develop succession planning for key technical leadership roles"),
                        html.Li("Create external visibility program to enhance team's thought leadership presence")
                    ])
                ], color="info")
            ], width=6),
            
            dbc.Col([
                html.H4("ðŸ“Š Development Pipeline", className="mb-3"),
                
                html.H6("Ready Now (0-6 months):"),
                html.Ul([
                    html.Li("Alex Olver â†’ Technical Lead role"),
                    html.Li("2-3 mid-level engineers â†’ Senior positions")
                ]),
                
                html.H6("Medium Term (6-18 months):"),
                html.Ul([
                    html.Li("Senior engineers â†’ Principal/Architect roles"),
                    html.Li("Graduate/Junior â†’ Mid-level progression"),
                    html.Li("Cross-training in emerging technologies")
                ]),
                
                html.H6("Long Term (18+ months):"),
                html.Ul([
                    html.Li("Next generation of technical leaders"),
                    html.Li("Thought leadership and external recognition"),
                    html.Li("Innovation and R&D capabilities")
                ])
            ], width=6)
        ])
    
    def create_directory_tab(self):
        """Create team directory tab"""
        
        return dbc.Row([
            dbc.Col([
                html.H4("ðŸ‘¥ Team Directory", className="mb-3"),
                
                dash_table.DataTable(
                    data=self.team_data.to_dict('records'),
                    columns=[
                        {'name': 'Name', 'id': 'name'},
                        {'name': 'Email', 'id': 'email'},
                        {'name': 'Role', 'id': 'role'},
                        {'name': 'Experience Level', 'id': 'experience_level'}
                    ],
                    filter_action="native",
                    sort_action="native",
                    page_size=15,
                    style_cell={'textAlign': 'left', 'fontSize': '14px'},
                    style_header={'backgroundColor': '#f8f9fa', 'fontWeight': 'bold'},
                    style_data_conditional=[
                        {
                            'if': {'filter_query': '{experience_level} = Senior'},
                            'backgroundColor': '#d1ecf1',
                            'color': 'black',
                        }
                    ]
                )
            ], width=12)
        ])
    
    def run(self, debug=False, host='127.0.0.1', port=8051):
        """Run the dashboard"""
        print(f"\nðŸš€ Team Intelligence Dashboard starting...")
        print(f"ðŸ“Š Loaded {len(self.team_data)} team members")
        print(f"ðŸŽ¯ URL: http://{host}:{port}")
        print(f"ðŸ”§ Integration ready for AI Dashboard as 9th tab")
        
        self.app.run(debug=debug, host=host, port=port)


def main():
    """Main entry point"""
    import os
    dashboard = TeamIntelligenceDashboard()
    
    # Get port from environment variable set by unified dashboard platform
    port = int(os.environ.get('DASHBOARD_PORT', 8051))
    host = os.environ.get('DASHBOARD_HOST', '127.0.0.1')
    
    dashboard.run(debug=True, host=host, port=port)


if __name__ == "__main__":
    main()