version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: servicedesk-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: servicedesk
      POSTGRES_USER: servicedesk_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ChangeMe123!}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups:/backups
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U servicedesk_user -d servicedesk"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - servicedesk-network

  # Grafana Dashboard
  grafana:
    image: grafana/grafana:10.2.2
    container_name: servicedesk-grafana
    restart: unless-stopped
    environment:
      # Security settings
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-admin}
      GF_SECURITY_SECRET_KEY: ${GRAFANA_SECRET_KEY:-change_this_secret_key}

      # Server settings
      GF_SERVER_ROOT_URL: http://localhost:3000
      GF_SERVER_DOMAIN: localhost

      # Analytics (disable for privacy)
      GF_ANALYTICS_REPORTING_ENABLED: "false"
      GF_ANALYTICS_CHECK_FOR_UPDATES: "false"

      # Logging
      GF_LOG_LEVEL: info
    ports:
      - "3000:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    networks:
      - servicedesk-network

volumes:
  postgres_data:
    driver: local
  grafana_data:
    driver: local

networks:
  servicedesk-network:
    driver: bridge
