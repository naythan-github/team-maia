name: Maia CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Quick checks - fast feedback (target: 30s)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci-quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for personal data
        run: |
          echo "ğŸ” Scanning for personal data..."
          if grep -rE "(naythandawe|/Users/naythan|/home/naythan)" \
             claude/ --include="*.py" --include="*.md" 2>/dev/null | \
             grep -v "CODEOWNERS\|CONTRIBUTING\|\.gitignore"; then
            echo "::error::Personal data detected in source files"
            exit 1
          fi
          echo "âœ… No personal data detected"

      - name: Check for hardcoded paths
        run: |
          echo "ğŸ” Scanning for hardcoded user paths..."
          if grep -rE '"/Users/[a-zA-Z]+|"/home/[a-zA-Z]+' \
             claude/tools --include="*.py" 2>/dev/null | \
             grep -v "test_\|# Example\|\.example"; then
            echo "::error::Hardcoded user paths detected"
            exit 1
          fi
          echo "âœ… No hardcoded paths detected"

      - name: Check naming conventions
        run: |
          echo "ğŸ” Checking naming conventions..."
          bad_files=$(find claude/tools -type f \( \
            -name "*_v[0-9]*" -o \
            -name "*_new.*" -o \
            -name "*_old.*" -o \
            -name "*_backup.*" -o \
            -name "*_copy.*" \
          \) 2>/dev/null | grep -v "experimental\|archive" || true)

          if [ -n "$bad_files" ]; then
            echo "::error::Naming convention violations found:"
            echo "$bad_files"
            exit 1
          fi
          echo "âœ… Naming conventions OK"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Security scan (target: 1m)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci-security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Secret detection (Trufflehog)
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha || 'HEAD~1' }}
          head: HEAD
          extra_args: --only-verified

      - name: Check for potential secrets in code
        run: |
          echo "ğŸ” Scanning for hardcoded secrets..."
          patterns='(api_key|secret|password|token|credential)\s*=\s*["\x27][A-Za-z0-9+/=_-]{20,}["\x27]'
          if grep -rEi "$patterns" claude/ --include="*.py" 2>/dev/null | \
             grep -v "test_\|# Example\|\.example\|getenv\|environ"; then
            echo "::warning::Potential hardcoded secrets found - review required"
          fi
          echo "âœ… Secret scan complete"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Tests (target: 2m)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci-tests:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install -r requirements-dev.txt 2>/dev/null || pip install pytest pytest-cov ruff

      - name: Run tests
        run: |
          python -m pytest tests/ -v --tb=short \
            --cov=claude/tools \
            --cov-report=term-missing \
            -x || true  # Don't fail CI if no tests yet

      - name: Lint with ruff
        run: |
          pip install ruff
          ruff check claude/tools --select=E,F,W --ignore=E501 || true

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Contribution review (target: 30s)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci-contribution-review:
    name: Contribution Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Run contribution reviewer
        run: |
          if [ -f "claude/hooks/contribution_reviewer.py" ]; then
            python3 claude/hooks/contribution_reviewer.py --ci
          else
            echo "âš ï¸ contribution_reviewer.py not yet implemented"
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Final gate
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ci-all-passed:
    name: All Checks Passed
    needs: [ci-quick-checks, ci-security, ci-tests, ci-contribution-review]
    runs-on: ubuntu-latest
    steps:
      - run: echo "âœ… All CI checks passed"
